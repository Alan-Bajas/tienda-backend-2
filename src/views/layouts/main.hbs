<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tienda</title>

  <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@2/css/pico.min.css">

  <style>
    header .brand { font-weight: 700; letter-spacing: .3px; }
    .grid { display: grid; gap: 1rem; }
    @media (min-width: 768px) { .grid.cols-3 { grid-template-columns: repeat(3, 1fr); } }
    .card { border: 1px solid var(--muted-border-color); border-radius: .8rem; overflow: hidden; background: var(--card-background-color); }
    .card img { width: 100%; height: 180px; object-fit: cover; }
    .card .body { padding: .9rem 1rem; }
    .badge { display: inline-block; font-size: .75rem; padding: .25rem .5rem; border-radius: 999px; background: var(--muted-color); color: white; }
    nav.pagination { display:flex; align-items:center; gap:.5rem; justify-content:center; margin-top:1rem; }
    nav.pagination a[role="button"] { margin: 0 .25rem; }
    .price { font-weight: 700; }
    .toolbar { display:flex; gap:.5rem; flex-wrap: wrap; align-items:center; margin-bottom: 1rem; }
    .qty-actions { display:flex; gap:.4rem; }
    .thumb { width:72px; height:72px; background:#eee; display:flex; align-items:center; justify-content:center; border-radius:.6rem; color:#999; font-size:.75rem; }
    .row { display:flex; gap:1rem; align-items:center; justify-content: space-between; }
    .row .left { display:flex; gap:1rem; align-items:center; }
    footer { margin-top: 3rem; color: var(--muted-color); font-size: .9rem; }
  </style>

  <link rel="icon" href="/favicon.ico">
</head>
<body>
  <header class="container">
    <nav>
      <ul>
        <li class="brand"><a href="/products" class="contrast">üõçÔ∏è Mi Tienda</a></li>
      </ul>
      <ul>
        <li><a href="/products" role="button" class="secondary">Productos</a></li>
        <li><a id="ver-carrito" href="#" role="button">Carrito</a></li>
      </ul>
    </nav>
  </header>

  <main class="container">
    {{{body}}}
  </main>

  <footer class="container">
    <hr />

  </footer>

  <script>
    (function () {
      const link = document.getElementById('ver-carrito');

      async function ensureCart() {
        try {
          let cid = localStorage.getItem('cid');
          if (!cid) {
            const r = await fetch('/api/carts', { method: 'POST' });
            const j = await r.json();
            cid = j?.payload?._id;
            localStorage.setItem('cid', cid);
          }
          return cid;
        } catch (err) {
          console.error(err);
          alert('No se pudo abrir el carrito.');
          return null;
        }
      }

      (async () => {
        const cid = localStorage.getItem('cid');
        link.href = cid ? ('/carts/' + cid) : '#';
      })();

      link.addEventListener('click', async (e) => {
        const href = link.getAttribute('href');
        if (!href || href === '#') {
          e.preventDefault();
          const cid = await ensureCart();
          if (cid) location.href = '/carts/' + cid;
        }
      });
    })();
  </script>
</body>
</html>
