<h2>Productos</h2>

<form method="GET" action="/products" class="toolbar">
  <input name="query" placeholder="p.ej. category:Accesorios | availability:true" value="{{query}}" />
  <select name="sort">
    <option value="">Orden: ninguno</option>
    <option value="asc"  {{#if (eq sort "asc")}}selected{{/if}}>Precio ↑</option>
    <option value="desc" {{#if (eq sort "desc")}}selected{{/if}}>Precio ↓</option>
  </select>
  <input type="number" name="limit" placeholder="limit" value="{{limit}}" min="1" />
  <button type="submit">Aplicar</button>
</form>

<div class="grid cols-3">
  {{#each payload}}
    <article class="card">
      {{#if this.thumbnail}}
        <img src="{{this.thumbnail}}" alt="{{this.title}}">
      {{else}}
        <img src="https://images.unsplash.com/photo-1527430253228-e93688616381?q=80&w=1200&auto=format&fit=crop" alt="Cover">
      {{/if}}
      <div class="body">
        <header class="row">
          <span class="badge">{{this.category}}</span>
          <span class="price">${{this.price}}</span>
        </header>
        <h3 style="margin:.4rem 0;">{{this.title}}</h3>
        <footer class="row">
          <small>Stock: {{this.stock}}</small>
          <button type="button" class="add" data-pid="{{this._id}}">Agregar</button>
        </footer>
      </div>
    </article>
  {{/each}}
</div>

<nav class="pagination">
  {{#if hasPrevPage}}<a role="button" class="secondary" href="{{prevLink}}">« Anterior</a>{{/if}}
  <span> Página {{page}} / {{totalPages}} </span>
  {{#if hasNextPage}}<a role="button" href="{{nextLink}}">Siguiente »</a>{{/if}}
</nav>

<script>
  (function(){
    async function ensureCart() {
      let cid = localStorage.getItem('cid');
      if (!cid) {
        const r = await fetch('/api/carts', { method:'POST' });
        const j = await r.json();
        cid = j?.payload?._id;
        localStorage.setItem('cid', cid);
      }
      return cid;
    }

    document.addEventListener('click', async (e) => {
      const btn = e.target.closest('.add');
      if (!btn) return;

      try {
        const pid = btn.dataset.pid;
        const cid = await ensureCart();

        const r = await fetch('/api/carts/' + cid);
        const j = await r.json();
        const items = (j?.payload?.products || []);
        const found = items.find(p => p.product._id === pid);

        if (found) {
          await fetch(`/api/carts/${cid}/products/${pid}`, {
            method: 'PUT',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ quantity: found.quantity + 1 })
          });
        } else {
          const newProducts = items.map(p => ({ product: p.product._id, quantity: p.quantity }));
          newProducts.push({ product: pid, quantity: 1 });
          await fetch(`/api/carts/${cid}`, {
            method: 'PUT',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ products: newProducts })
          });
        }

        btn.setAttribute('aria-busy', 'true');
        setTimeout(() => btn.removeAttribute('aria-busy'), 500);
      } catch (err) {
        console.error(err);
        alert('No se pudo agregar: ' + err.message);
      }
    });
  })();
</script>
